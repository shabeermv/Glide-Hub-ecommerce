<%-include("../../views/partials/users/header.ejs")%>

<body>
    <div class="page-wrapper">
        <main class="main">
            <div class="page-header text-center" style="background-image: url('/asset3/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">My Account<span>Shop</span></h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">My Account</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->
        
            <div class="page-content">
                <div class="dashboard">
                    <div class="container">
                        <div class="row">
                            <aside class="col-md-4 col-lg-3">
                                <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="tab-dashboard-link" data-toggle="tab" href="#tab-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="true">Personal Information</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-orders-link" data-toggle="tab" href="#tab-orders" role="tab" aria-controls="tab-orders" aria-selected="false">Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-wallet-link" data-toggle="tab" href="#tab-wallet" role="tab" aria-controls="tab-wallet" aria-selected="false">Wallet</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-address-link" data-toggle="tab" href="#tab-address" role="tab" aria-controls="tab-address" aria-selected="false">Adresses</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-coupons-link" data-toggle="tab" href="#tab-coupons" role="tab" aria-controls="tab-coupons" aria-selected="false">Coupons & Offers</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/logout">Sign Out</a>
                                    </li>
                                </ul>
                            </aside><!-- End .col-lg-3 -->
        
                            <div class="col-md-8 col-lg-9">
                                <div class="tab-content">
                                    <!-- Dashboard Tab -->
                                    <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard-link">
                                        <div style="margin-top: 30px;">
                                            <!-- My Cart Button -->
                                            <a href="/cart" class="btn btn-success" style="margin-right: 10px;">My Cart</a>
                                            <a href="/wishlist" class="btn btn-primary" style="margin-right: 10px;">My Wishlist</a>
                                            <a href="/resetPassword" class="btn btn-secondary">Reset Password</a>
                                        </div>
                                    
                                        
                                        <div class="card mt-4 shadow-sm w-50 mx-auto">
                                            <div class="card-body">
                                                <h5 class="card-title">User Details</h5>
                                        
                                                
                                                <div id="errorMessages" class="text-danger mb-3"></div>
                                        
                                                <p class="card-text"><strong>Full Name:</strong> 
                                                    <span id="fullName"><%= user.username %></span>
                                                    <input type="text" id="editFullName" class="form-control d-none" value="<%= user.username %>">
                                                </p>
                                                
                                                <p class="card-text"><strong>Email:</strong> 
                                                    <span id="email"><%= user.email %></span>
                                                    <input type="email" id="editEmail" class="form-control d-none" value="<%= user.email %>" readonly>
                                                </p>
                                        
                                                <p class="card-text"><strong>Mobile Number:</strong> 
                                                    <span id="mobileNumber"><%= user.contact %></span>
                                                    <input type="text" id="editMobileNumber" class="form-control d-none" value="<%= user.contact %>">
                                                </p>
                                        
                                                <button class="btn btn-warning mt-2" id="editButton" onclick="enableEdit()">Edit</button>
                                                <button class="btn btn-success mt-2 d-none" id="saveButton" onclick="saveChanges()">Save</button>
                                            </div>
                                        </div>
                                        
                                    
                                        <div class="mt-4">
                                            <label for="referralCode"><strong>My Referral Code:</strong></label>
                                            <div class="input-group" style="max-width: 300px;">
                                                <input type="text" id="referralCode" class="form-control" value="<%= referralCode %>" readonly>
                                                <button class="btn btn-outline-secondary" onclick="copyReferralCode()">
                                                    <i class="icon-copy"></i> Copy
                                                </button>
                                            </div>
                                        </div>
        
                                        <div class="mt-4">
                                            <a href="/shop" class="btn btn-outline-primary-2">
                                                <span>GO SHOP</span>
                                                <i class="icon-long-arrow-right"></i>
                                            </a>
                                        </div>
                                    </div><!-- End .tab-pane -->
        
                                    
                                    <div class="tab-pane fade" id="tab-orders" role="tabpanel" aria-labelledby="tab-orders-link">
                                        <div class="container">
                                            <h3 class="mb-4">Your Orders</h3>
                                            <% if (orders && orders.length > 0) { %>
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover">
                                                        <thead class="thead-dark">
                                                            <tr>
                                                                <th>Order ID</th>
                                                                <th>Date</th>
                                                                <th>Products</th>
                                                                <th>Total Amount</th>
                                                                <th>Status</th>
                                                                <th style="width: 200px;">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% orders.forEach(order => { %>
                                                                <tr>
                                                                    <td><%= order.orderId %></td>
                                                                    <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                                                                    <td>
                                                                        <ul class="list-unstyled mb-0">
                                                                            <% order.products.forEach(product => { %>
                                                                                <li class="mb-1">
                                                                                    <%= product.productId ? product.productId.title : 'Product Not Found' %> 
                                                                                    - ₹<%= product.productId.price %> 
                                                                                    <% if (product.status === "Cancelled") { %>
                                                                                        <span class="text-danger">(Cancelled)</span>
                                                                                    <% } %>
                                                                                </li>
                                                                            <% }) %>
                                                                        </ul>
                                                                    </td>
                                                                    <td>
                                                                        <strong>₹<%= order.totalAmount %></strong>
                                                                    </td>
                                                                    <td>
                                                                        <span class="badge badge-<%= 
                                                                            order.orderStatus === 'Completed' ? 'success' : 
                                                                            order.orderStatus === 'Shipped' ? 'primary' : 
                                                                            order.orderStatus === 'Pending' ? 'warning' : 
                                                                            order.orderStatus === 'Cancelled' ? 'danger' :
                                                                            order.orderStatus === 'Returned' ? 'secondary' :
                                                                            order.orderStatus === 'Return Requested' ? 'info' :
                                                                            order.orderStatus === 'Cancel Requested' ? 'info' : 'info' 
                                                                        %> p-2">
                                                                            <%= order.orderStatus %>
                                                                        </span>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <div class="btn-group" role="group">
                                                                            <a href="/order/details/<%= order._id %>" class="btn btn-sm btn-info" style="margin-right: 5px;">
                                                                                View Details
                                                                            </a>
                                                        
                                                                            <% if (order.orderStatus === 'Delivered') { %>
                                                                                <button class="btn btn-sm btn-warning return-order-btn"
                                                                                    data-order-id="<%= order._id %>">
                                                                                    Return Order
                                                                                </button>
                                                        
                                                                            <% } else if (order.orderStatus !== 'Cancelled' && order.orderStatus !== 'Completed' && 
                                                                            order.orderStatus !== 'Returned' && order.orderStatus !== 'Return Requested' && 
                                                                            order.orderStatus !== 'Cancel Requested') { %>
                                                                                <button class="btn btn-sm btn-danger cancel-order-btn"
                                                                                        data-order-id="<%= order._id %>">
                                                                                    Cancel Order
                                                                                </button>
                                                                            <% } %>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            <% }) %>
                                                        </tbody>
                                                        
                                                    </table>
                                                </div>
                                            <% } else { %>
                                                <div class="alert alert-info">
                                                    <p class="mb-0">You haven't placed any orders yet.</p>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div><!-- End .tab-pane -->
        
                                    <!-- Wallet Tab -->
                                    <div class="tab-pane fade" id="tab-wallet" role="tabpanel" aria-labelledby="tab-wallet-link">
                                        <div class="container">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="card card-dashboard">
                                                        <div class="card-body">
                                                            <h3 class="card-title">Wallet Balance</h3>
                                                            <div class="wallet-balance-section mb-4">
                                                                <h2 class="text-primary">₹<%= user.wallet ? user.wallet.toFixed(2) : '0.00' %></h2>
                                                                <p class="text-muted">Available Balance</p>
                                                            </div>
        
                                                            <div class="wallet-actions mb-4">
                                                                <button class="btn btn-primary mr-2" data-toggle="modal" data-target="#addMoneyModal">
                                                                    <i class="icon-plus"></i> Add Money
                                                                </button>
                                                                
                                                            </div>
                                                            <h4 class="mt-4">Wallet Transactions</h4>
<table class="table table-bordered mt-3">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Amount</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <% if (user.walletHistory && user.walletHistory.length > 0) { %>
      <% user.walletHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(txn => { %>
        <tr>
          <td><%= new Date(txn.date).toLocaleDateString("en-IN") %></td>
          <td><%= txn.description || '-' %></td>
          <td>
            <% if (txn.type === "credit") { %>
               <span class="text-danger">- ₹<%= txn.amount.toFixed(2) %></span>
            <% } else { %>
                <span class="text-success">+ ₹<%= txn.amount.toFixed(2) %></span>
             
            <% } %>
          </td>
          <td>
            <% if (txn.type === "credit") { %>
              <i class="icon-arrow-down text-danger"></i>
            <% } else { %>
                <i class="icon-arrow-up text-success"></i>
              
            <% } %>
          </td>
        </tr>
      <% }) %>
    <% } else { %>
      <tr>
        <td colspan="4" class="text-center text-muted">No wallet transactions yet.</td>
      </tr>
    <% } %>
  </tbody>
</table>

        
                                                            
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- End .tab-pane -->
        
                                    
                                    <div class="tab-pane fade" id="tab-address" role="tabpanel" aria-labelledby="tab-address-link">
                                        <p>The following addresses will be used on the checkout page by default.</p>
                                        <div class="row">
                                            <% if (user && user.address && user.address.length > 0) { %>
                                                <% user.address.forEach(function(address, index) { %>
                                                    <div class="col-lg-6">
                                                        <div class="card card-dashboard">
                                                            <div class="card-body">
                                                                <h3 class="card-title">Address <%= index + 1 %></h3>
                                                                <br>
                                                                <p>
                                                                    <%= user.username %><br>
                                                                    <%= user.contact %><br>
                                                                    <%= user.email %><br>
                                                                    <%= address.address %><br>
                                                                    <%= address.city %><br>
                                                                    <%= address.state %><br>
                                                                    <%= address.postCode %><br>
                                                                    <%= address.country %><br>
                                                                    <a href="/editProfile/<%= address._id %>">Edit <i class="icon-edit"></i></a>
                                                                    <button type="submit" class="btn btn-danger" data-address-id="<%= address._id %>">Delete</button>
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                <% }); %>
                                            <% } else { %>
                                                <p class="text-danger">No saved addresses found.</p>
                                            <% } %>
                                            
                                        </div>
                                        <div class="col-12">
                                            <a href="javascript:void(0)" id="showAddressForm" class="btn btn-outline-primary-2 mt-4">
                                                <span>ADD NEW ADDRESS</span>
                                                <i class="icon-plus"></i>
                                            </a>
                                        </div>
                                        
                                        <div id="addressFormContainer" class="mt-4">
                                            <form id="newAddressForm" class="address-form" style="background: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); width: 100%; max-width: 600px; margin-top: 40px;">
                                                <h2 style="text-align: center; color: #3a3b3d; margin-bottom: 20px;">Add Address</h2>
                                        
                                                <label for="newFullName" style="color: #343a40; font-weight: bold;">Full Name *</label>
                                                <input type="text" id="newFullName" name="fullName" class="form-control" required>
                                        
                                                <label for="newAddress" style="color: #343a40; font-weight: bold;">Address *</label>
                                                <input type="text" id="newAddress" name="address" class="form-control" required>
                                        
                                                <label for="newCity" style="color: #343a40; font-weight: bold;">City *</label>
                                                <input type="text" id="newCity" name="city" class="form-control" required>
                                        
                                                <label for="newState" style="color: #343a40; font-weight: bold;">State *</label>
                                                <input type="text" id="newState" name="state" class="form-control" required>
                                        
                                                <label for="newPostCode" style="color: #3a3b3d; font-weight: bold;">Post Code *</label>
                                                <input type="text" id="newPostCode" name="postCode" class="form-control" required>
                                        
                                                <label for="newCountry" style="color: #3a3b3d; font-weight: bold;">Country *</label>
                                                <input type="text" id="newCountry" name="country" class="form-control" required>
                                        
                                                <button id="saveNewAddress" type="submit" class="btn btn-block" style="background-color: #3a3b3d; color: #fff; font-weight: bold;">
                                                    SAVE CHANGES
                                                </button>
                                        
                                                <div id="response-message" class="mt-3" style="text-align: center;"></div>
                                            </form>
                                        </div>
                                        
                                    </div><!-- End .tab-pane -->
                                    
                                    
                                    <div class="tab-pane fade" id="tab-coupons" role="tabpanel" aria-labelledby="tab-coupons-link">
                                        <div class="container">
                                            <h3 class="mb-4">Your Coupons & Offers</h3>
                                    
                                            <% if (coupons.length === 0) { %>
                                                <div class="alert alert-info">
                                                    <p class="mb-0">You don't have any active coupons or offers at the moment.</p>
                                                </div>
                                            <% } else { %>
                                                <div class="row">
                                                    <% coupons.forEach(coupon => { %>
                                                        <div class="col-md-6">
                                                            <div class="card mb-3">
                                                                <div class="card-body">
                                                                    <h5 class="card-title">
                                                                        <strong><%= coupon.name %></strong> 
                                                                        <span class="badge badge-success"><%= coupon.discountValue %> 
                                                                            <%= coupon.discount === 'percentage' ? '%' : '₹' %> OFF
                                                                        </span>
                                                                    </h5>
                                                                    <p class="card-text">
                                                                        <strong>Code:</strong> <span class="text-primary"><%= coupon.code %></span><br>
                                                                        <strong>Min Purchase:</strong> ₹<%= coupon.minPurchase.toFixed(2) %><br>
                                                                        <strong>Expires:</strong> <%= new Date(coupon.expireDate).toLocaleDateString() %>
                                                                    </p>
                                                                    <button class="btn btn-outline-primary btn-sm" onclick="copyCoupon('<%= coupon.code %>')">
                                                                        Copy Code
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    <% }); %>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                    <script>
                                    function copyCoupon(code) {
                                        navigator.clipboard.writeText(code);
                                        alert("Coupon code copied: " + code);
                                    }
                                    </script>
                                </div><!-- End .tab-content -->
                            </div><!-- End .col-lg-9 -->
                        </div><!-- End .row -->
                    </div><!-- End .container -->
                </div><!-- End .dashboard -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->
        
        <div class="modal fade" id="addMoneyModal" tabindex="-1" role="dialog" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addMoneyModalLabel">Add Money to Wallet</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="addMoneyForm" action="/add-money" method="POST">
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="amount">Amount ($)</label>
                                <input type="number" class="form-control" id="amount" name="amount" min="1" step="0.01" required>
                            </div>
                            
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Money</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        
        

        
        <div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="orderDetailsContent">
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        
        <div id="successModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Success</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="modalMessage">Address added successfully!</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            
            .wallet-balance-section {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }
            
            .wallet-balance-section h2 {
                font-size: 2.5rem;
                margin-bottom: 5px;
            }
            
            .wallet-actions {
                text-align: center;
            }
            
            .wallet-transactions {
                margin-top: 30px;
            }
            
            
            .table td, .table th {
                vertical-align: middle;
            }
            
            .table thead th {
                background-color: #f8f9fa;
                border-bottom: 2px solid #dee2e6;
            }
            
            .badge {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            .btn-group .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            
            .modal-dialog {
                max-width: 600px;
                margin: 30px auto;
            }
            
            .modal-content {
                width: 100%;
            }
            
            .modal-lg {
                max-width: 800px;
            }
            #errorMessages, #errorMessages p {
    color: red !important;
    font-weight: bold;
}

        </style>
                                        


                                            <!-- End .col-lg-6 -->
                                            
								    
                                    <!-- .End .tab-pane -->
								</div>
	                		</div><!-- End .col-lg-9 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .dashboard -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->

<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnModalLabel">Return Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="returnForm">
                    <input type="hidden" id="returnOrderId">

                    <label for="reason">Select a Reason:</label>
                    <select class="form-select" id="reason" required>
                        <option value="Damaged product">Damaged product</option>
                        <option value="Wrong item received">Wrong item received</option>
                        <option value="Not as described">Not as described</option>
                        <option value="Other">Other</option>
                    </select>

                    <div class="mt-2">
                        <label for="customReason">Additional Details (Optional):</label>
                        <textarea class="form-control" id="customReason" placeholder="Enter additional details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="submitReturn()">Submit Return</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="returnRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Your return request has been submitted successfully!</p>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">Cancel Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelOrderForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cancelReasonSelect" class="form-label">Select a Reason:</label>
                        <select class="form-select" id="cancelReasonSelect" required>
                            <option value="">Please select a reason</option>
                            <option value="Changed my mind">Changed my mind</option>
                            <option value="Found better price elsewhere">Found better price elsewhere</option>
                            <option value="Ordered by mistake">Ordered by mistake</option>
                            <option value="Taking too long to ship">Taking too long to ship</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cancelAdditionalDetails" class="form-label">Additional Details (Optional):</label>
                        <textarea class="form-control" id="cancelAdditionalDetails" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelModalCloseBtn">Close</button>
                    <button type="submit" class="btn btn-danger">Submit Cancellation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="cancelRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Your cancel request has been submitted successfully!</p>
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="reloadPage()">OK</button>
            </div>
        </div>
    </div>
</div>

    
    <script src="/asset3/js/jquery.min.js"></script>
    <script src="/asset3/js/bootstrap.bundle.min.js"></script>
    <script src="/asset3/js/jquery.hoverIntent.min.js"></script>
    <script src="/asset3/js/jquery.waypoints.min.js"></script>
    <script src="/asset3/js/superfish.min.js"></script>
    <script src="/asset3/js/owl.carousel.min.js"></script>
    <script src="/asset3/js/main.js"></script>
 

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>

function enableEdit() {
    document.getElementById("fullName").classList.add("d-none");
    document.getElementById("mobileNumber").classList.add("d-none");

    document.getElementById("editFullName").classList.remove("d-none");
    document.getElementById("editMobileNumber").classList.remove("d-none");

    document.getElementById("editButton").classList.add("d-none");
    document.getElementById("saveButton").classList.remove("d-none");
}

function saveChanges() {
    const fullNameInput = document.getElementById("editFullName");
    const mobileNumberInput = document.getElementById("editMobileNumber");
    const errorMessagesDiv = document.getElementById("errorMessages");

    const newFullName = fullNameInput.value.trim();
    const newMobileNumber = mobileNumberInput.value.trim();

    const nameRegex = /^[A-Za-z\s]+$/;
    const mobileRegex = /^[0-9]{10}$/; // ✅ Exactly 10 digits only

    errorMessagesDiv.innerHTML = "";
    let errors = [];

    if (!newFullName) {
        errors.push("Full Name cannot be empty.");
    } else if (!nameRegex.test(newFullName)) {
        errors.push("Full Name can only contain letters and spaces.");
    }

    if (!newMobileNumber) {
        errors.push("Mobile Number cannot be empty.");
    } else if (!mobileRegex.test(newMobileNumber)) {
        errors.push("Mobile Number must be exactly 10 digits and contain only numbers.");
    }

    if (errors.length > 0) {
        errorMessagesDiv.innerHTML = errors.map(error => `<p>${error}</p>`).join("");
        return;
    }

    // ✅ Update the displayed values
    document.getElementById("fullName").textContent = newFullName;
    document.getElementById("mobileNumber").textContent = newMobileNumber;

    // ✅ Toggle visibility back
    document.getElementById("fullName").classList.remove("d-none");
    document.getElementById("mobileNumber").classList.remove("d-none");

    fullNameInput.classList.add("d-none");
    mobileNumberInput.classList.add("d-none");

    document.getElementById("editButton").classList.remove("d-none");
    document.getElementById("saveButton").classList.add("d-none");

    
    fetch('/updateUserDetails', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            fullName: newFullName,
            mobileNumber: newMobileNumber
        })
    })
    .then(response => response.json())
    .then(data => console.log("User details updated:", data))
    .catch(error => console.error("Error updating user details:", error));
}

document.querySelectorAll('.return-order-btn').forEach(button => {
    button.addEventListener('click', function() {
        const orderId = this.getAttribute('data-order-id');
        console.log('Return button clicked for order:', orderId);
        
        document.getElementById('returnOrderId').value = orderId;
        
        const modal = new bootstrap.Modal(document.getElementById('returnModal'));
        modal.show();
    });
});

async function submitReturn() {
    const orderId = document.getElementById('returnOrderId').value;
    console.log('Submitting return for order:', orderId);
    const reason = document.getElementById('reason').value;
    const customReason = document.getElementById('customReason').value;
    
    try {
        const response = await fetch(`/requestReturn/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, customReason })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Return response:', data);
        
        if (data.success) {
            const returnModal = bootstrap.Modal.getInstance(document.getElementById('returnModal'));
            returnModal.hide();
            
           
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert(data.message || 'Failed to submit return request.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
    }
}
document.addEventListener("DOMContentLoaded", function () {
    const showAddressFormButton = document.getElementById("showAddressForm");
    const addressFormContainer = document.getElementById("addressFormContainer");
    const addressForm = document.getElementById("newAddressForm");


    addressFormContainer.style.display = "none";

    showAddressFormButton.addEventListener("click", function () {
        if (addressFormContainer.style.display === "none" || addressFormContainer.style.display === "") {
            addressFormContainer.style.display = "block";
            showAddressFormButton.innerHTML = '<span>HIDE FORM</span> <i class="icon-minus"></i>';
        } else {
            addressFormContainer.style.display = "none";
            showAddressFormButton.innerHTML = '<span>ADD NEW ADDRESS</span> <i class="icon-plus"></i>';
        }
    });
    
    addressForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const addressData = {
    fullName: document.getElementById("newFullName").value.trim(),
    address: document.getElementById("newAddress").value.trim(),
    city: document.getElementById("newCity").value.trim(),
    state: document.getElementById("newState").value.trim(),
    postCode: document.getElementById("newPostCode").value.trim(),
    country: document.getElementById("newCountry").value.trim(),
};


    console.log("Sending Address Data:", addressData);

    try {
        const response = await fetch("/accountDetails", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(addressData), 
        });

        const result = await response.json();
        console.log("📥 Server Response:", result);

        if (response.ok && result.success) {
            showMessage(result.message || "Address added successfully!", "green");

            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(result.message || "Failed to add address.", "red");
        }
    } catch (error) {
        console.error("Fetch error:", error);
        showMessage("An unexpected error occurred. Please try again.", "red");
    }
});
});

    
       document.querySelectorAll('.view-details-btn').forEach(button => {
    button.addEventListener('click', async function() {
        const orderId = this.getAttribute('data-order-id');
        try {
            const response = await fetch(`/order-details/${orderId}`);
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('orderDetailsContent').innerHTML = `
                    <div class="order-details">
                        <h6>Order ID: ${data.order.orderId}</h6>
                        <p>Date: ${new Date(data.order.createdAt).toLocaleDateString()}</p>
                        <p>Status: ${data.order.orderStatus}</p>
                        <hr>
                        <h6>Products:</h6>
                        <ul>
                            ${data.order.products.map(product => `
                                <li>${product.productId.title} - Quantity: ${product.quantity}</li>
                            `).join('')}
                        </ul>
                        <hr>
                        <p><strong>Total Amount: $${data.order.totalAmount.toFixed(2)}</strong></p>
                    </div>
                `;
                
                $('#orderDetailsModal').modal('show');
            } else {
                alert('Failed to load order details');
            }
        } catch (error) {
            console.error('Error loading order details:', error);
            alert('An error occurred while loading order details');
        }
    });
});


document.querySelectorAll('.cancel-order-btn').forEach(button => {
    button.addEventListener('click', function() {
        const orderId = this.getAttribute('data-order-id');
        
        const cancelModal = document.getElementById('cancelModal');
        cancelModal.setAttribute('data-order-id', orderId);
        
        const modal = new bootstrap.Modal(cancelModal);
        modal.show();
    });
});

document.getElementById('cancelOrderForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const cancelModal = document.getElementById('cancelModal');
    const orderId = cancelModal.getAttribute('data-order-id');
    
    const reasonSelect = document.getElementById('cancelReasonSelect');
    const reason = reasonSelect.value;
    
    const additionalDetails = document.getElementById('cancelAdditionalDetails').value;
    
    try {
        const response = await fetch(`/cancelOrder/${orderId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reason: reason,
                additionalDetails: additionalDetails
            })
        });
        console.log('this is the page',reason);
        const result = await response.json();
        
        const modalInstance = bootstrap.Modal.getInstance(cancelModal);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        if (result.success) {
            const successModal = new bootstrap.Modal(document.getElementById('cancelRequestModal'));
            successModal.show();
        } else {
            alert(result.message || 'Failed to cancel order');
        }
    } catch (error) {
        console.error('Error cancelling order:', error);
        alert('An error occurred while cancelling the order');
    }
    
    return false;
});

document.getElementById('cancelModalCloseBtn').addEventListener('click', function() {
    const cancelModal = document.getElementById('cancelModal');
    const modalInstance = bootstrap.Modal.getInstance(cancelModal);
    if (modalInstance) {
        modalInstance.hide();
    }
});

document.getElementById('submitCancelButton').addEventListener('click', function(event) {
    event.preventDefault();
    
    const form = document.getElementById('cancelOrderForm');
    const submitEvent = new Event('submit', {
        bubbles: true,
        cancelable: true
    });
    form.dispatchEvent(submitEvent);
    
    return false;
});


function showMessage(message, color) {
    const messageElement = document.getElementById("response-message");
    messageElement.textContent = message;
    messageElement.style.color = color;
}
function showMessage(message, color) {
    const messageElement = document.getElementById("response-message");
    messageElement.textContent = message;
    messageElement.style.color = color;
}



function copyReferralCode() {
  const referralCodeInput = document.getElementById('referralCode');
  referralCodeInput.select();
  document.execCommand('copy');
  
  alert('Referral code copied to clipboard!');
  // Or for a more modern approach:
  // navigator.clipboard.writeText(referralCodeInput.value)
  //   .then(() => {
  //     alert('Referral code copied to clipboard!');
  //   });
}

function showModal(message) {
    document.getElementById('modalMessage').textContent = message;
    $('#successModal').modal('show');
}



function showModal(message) {
    
    document.getElementById('modalMessage').textContent = message;

    
    $('#successModal').modal('show');
}


 
document.querySelectorAll('.btn-danger').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();

        
        const addressId = button.getAttribute('data-address-id');

        console.log(addressId, 'address id');

        
        fetch(`/deleteAddress/${addressId}`, {
            method: "DELETE",
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Address deleted successfully');
                
                window.location.reload();
            } else {
                alert('Error deleting address: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting address:', error);
            alert('Error deleting address: ' + error.message);
        });
    });
});

 </script>
    
        
    
    <%-include("../../views/partials/users/footer.ejs")%>


