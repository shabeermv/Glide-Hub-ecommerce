<%- include("../../views/partials/users/header.ejs") %>

<main class="main">
  <div
    class="page-header text-center"
    style="background-image: url('/asset3/images/page-header-bg.jpg')"
  >
    <div class="container">
      <h1 class="page-title">Wishlist<span>Shop</span></h1>
    </div>
  </div>

  <nav aria-label="breadcrumb" class="breadcrumb-nav">
    <div class="container">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
        <li class="breadcrumb-item active" aria-current="page">Wishlist</li>
      </ol>
    </div>
  </nav>

  <div class="page-content">
    <div class="container">
      <% if (wishlist.length === 0) { %>
      <p>No products in your wishlist.</p>
      <% } else { %>
      <table class="table table-wishlist table-mobile">
        <% wishlist.forEach(item => { %> <% if (item.productId) { %>
        <tr>
          <td class="product-col">
            <div class="product">
              <figure class="product-media">
                <% if (item.productId && item.productId.image &&
                item.productId.image.length > 0) { %>
                <img
                  src="<%= item.productId.image[0] %>"
                  alt="<%= item.productId.title %>"
                  class="product-image"
                />
                <% } else { %>
                <img
                  src="/default-image.jpg"
                  alt="No Image Available"
                  class="product-image"
                />
                <% } %>
              </figure>
              <h3 class="product-title">
                <a href="/show/<%= item.productId._id %>">
                  <%= item.productId.title %>
                </a>
              </h3>
            </div>
          </td>
          <td class="price-col"><%= item.productId.price %></td>
          <td class="stock-col">
            <span
              class="<%= item.productId.stock > 0 ? 'in-stock' : 'out-of-stock' %>"
            >
              <%= item.productId.totalStock > 0 ? 'In stock' : 'Out of stock' %>
            </span>
          </td>
          <td class="action-col">
            <button
              class="add-to-cart-btn btn btn-warning"
              data-product-id="<%= item.productId._id %>"
              data-product-title="<%= item.productId.title %>"
              data-product-price="<%= item.productId.price %>"
              data-product-sizes="<%- JSON.stringify(item.productId.sizes || []) %>"
            >
              Add to Cart
            </button>
          </td>
          <td class="remove-col">
            <button class="btn-remove" data-id="<%= item.productId._id %>">
              <i class="icon-close"></i>
            </button>
          </td>
        </tr>
        <% } %> <% }); %>
      </table>
      <% } %>
    </div>
  </div>

  <div class="pagination-container">
    <% if (totalPages > 1) { %>
    <ul class="pagination">
      <% if (currentPage > 1) { %>
      <li class="page-item">
        <a
          class="page-link"
          href="/wishlist?page=<%= currentPage - 1 %>&limit=5"
          >Previous</a
        >
      </li>
      <% } %> <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a class="page-link" href="/wishlist?page=<%= i %>&limit=5"><%= i %></a>
      </li>
      <% } %> <% if (currentPage < totalPages) { %>
      <li class="page-item">
        <a
          class="page-link"
          href="/wishlist?page=<%= currentPage + 1 %>&limit=5"
          >Next</a
        >
      </li>
      <% } %>
    </ul>
    <% } %>
  </div>

  <!-- Size Selection Modal -->
  <div
    class="modal fade"
    id="sizeModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="sizeModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sizeModalLabel">Select Size</h5>
          <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="product-info mb-3">
            <h6 id="modalProductTitle"></h6>
            <p class="text-muted">
              Price: <span id="modalProductPrice"></span>
            </p>
          </div>
          <form id="sizeForm">
            <input type="hidden" id="modalProductId" />

            <div class="form-group">
              <label for="productSize">Choose Size:</label>
              <select id="productSize" class="form-control" required>
                <option value="">Select Size</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Cancel
          </button>
          <button type="button" id="confirmAddToCart" class="btn btn-primary">
            Add to Cart
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div
    class="modal fade"
    id="successModal"
    tabindex="-1"
    aria-labelledby="successModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <!-- Modal Body -->
        <div class="modal-body text-center p-5">
          <!-- Animated check circle -->
          <div class="mb-3">
            <i
              class="fa fa-check-circle text-success"
              style="font-size: 4rem; animation: pop 0.4s ease"
            ></i>
          </div>
          <h4 class="fw-bold text-dark mb-2">Item Added!</h4>
          <p class="text-muted">
            Your product has been successfully added to the cart.
          </p>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer border-0 justify-content-center pb-4">
          <a href="/shop" class="btn btn-outline-secondary px-4">
            <i class="fa fa-arrow-left me-1"></i> Continue Shopping
          </a>
          <a href="/cart" class="btn btn-success px-4">
            <i class="fa fa-shopping-cart me-1"></i> Go to Cart
          </a>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes pop {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>

  <!-- Remove Confirmation Modal -->
  <div
    class="modal fade"
    id="removeConfirmModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="removeConfirmModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="removeConfirmModalLabel">
            <i class="fa fa-exclamation-triangle mr-2"></i> Remove Item
          </h5>
          <button
            type="button"
            class="close text-white"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center">
          <p>
            Are you sure you want to remove
            <strong id="removeProductTitle"></strong> from your wishlist?
          </p>
          <input type="hidden" id="removeProductId" />
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Cancel
          </button>
          <button type="button" id="confirmRemoveBtn" class="btn btn-danger">
            Remove
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Remove Modal -->
  <div
    class="modal fade"
    id="removeSuccessModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="removeSuccessModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="removeSuccessModalLabel">
            <i class="fa fa-check-circle mr-2"></i> Removed!
          </h5>
          <button
            type="button"
            class="close text-white"
            data-dismiss="modal"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center">
          <i
            class="fa fa-check-circle text-success mb-3"
            style="font-size: 3rem"
          ></i>
          <h5>Product removed from wishlist successfully!</h5>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <a href="/wishlist" class="btn btn-success">Go to Wishlist</a>
        </div>
      </div>
    </div>
  </div>

  <style>
    .pagination-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .pagination {
      list-style: none;
      display: flex;
      gap: 10px;
      padding: 0;
    }

    .pagination .page-item {
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .pagination .page-link {
      padding: 5px 10px;
      text-decoration: none;
      color: #007bff;
    }

    .pagination .page-item.active .page-link {
      background-color: #007bff;
      color: #fff;
      pointer-events: none;
    }

    .product-info {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
    }

    .btn-remove {
      background: none;
      border: none;
      color: #dc3545;
      font-size: 18px;
      cursor: pointer;
    }

    .btn-remove:hover {
      color: #c82333;
    }

    /* Success Modal Styles */
    .success-icon {
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-dialog-centered {
      display: flex;
      align-items: center;
      min-height: calc(100% - 1rem);
    }

    .bg-success {
      background-color: #28a745 !important;
    }

    .text-success {
      color: #28a745 !important;
    }
  </style>
</main>

<%- include("../../views/partials/users/footer.ejs") %>

<script>
  document.querySelectorAll(".btn-remove").forEach((button) => {
    button.addEventListener("click", function (e) {
      e.preventDefault();

      const productId = this.getAttribute("data-id");
      const productTitle =
        this.closest("tr").querySelector(".product-title a").textContent;

      // Populate modal
      document.getElementById("removeProductId").value = productId;
      document.getElementById("removeProductTitle").textContent = productTitle;

      // Show modal
      $("#removeConfirmModal").modal("show");
    });
  });

  // Confirm remove action
  document
    .getElementById("confirmRemoveBtn")
    .addEventListener("click", function () {
      const productId = document.getElementById("removeProductId").value;

      fetch(`/removeWishlistItem/${productId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          $("#removeConfirmModal").modal("hide"); // Close confirmation modal

          if (data.success) {
            // After confirm modal hides, show success modal
            $("#removeConfirmModal").on("hidden.bs.modal", function () {
              $("#removeSuccessModal").modal("show");
              $(this).off("hidden.bs.modal");
            });

            $("#removeSuccessModal").on("hidden.bs.modal", function () {
              window.location.reload();
            });
          } else {
            alert(data.message || "Error removing product from wishlist.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Internal server error. Please try again later.");
        });
    });
  document.querySelectorAll(".add-to-cart-btn").forEach((button) => {
    button.addEventListener("click", function (e) {
      e.preventDefault();

      const productId = this.getAttribute("data-product-id");
      const productTitle = this.getAttribute("data-product-title");
      const productPrice = this.getAttribute("data-product-price");
      const sizesData = this.getAttribute("data-product-sizes");

      console.log("Raw sizes data:", sizesData); // Debug log

      let productSizes = [];
      try {
        productSizes = JSON.parse(sizesData);
        console.log("Parsed sizes:", productSizes); // Debug log
      } catch (error) {
        console.error("Error parsing sizes:", error);
        productSizes = [];
      }

      // Populate modal with product information
      document.getElementById("modalProductId").value = productId;
      document.getElementById("modalProductTitle").textContent = productTitle;
      document.getElementById("modalProductPrice").textContent = productPrice;

      // Clear and populate size options
      const sizeSelect = document.getElementById("productSize");
      sizeSelect.innerHTML = '<option value="">-- Select Size --</option>';

      // Handle the nested size structure from your schema
      if (Array.isArray(productSizes) && productSizes.length > 0) {
        productSizes.forEach((sizeObj) => {
          if (sizeObj && sizeObj.size && sizeObj.stock > 0) {
            // Only show sizes that are in stock
            const option = document.createElement("option");
            option.value = sizeObj.size;
            option.textContent = `${sizeObj.size} (Stock: ${sizeObj.stock})`;
            option.setAttribute("data-stock", sizeObj.stock);
            sizeSelect.appendChild(option);
          }
        });
      } else {
        // Fallback if sizes data is not available
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No sizes available";
        option.disabled = true;
        sizeSelect.appendChild(option);
      }

      // Reset quantity to 1 (hidden, always 1)
      const quantity = 1;

      // Show the modal
      $("#sizeModal").modal("show");
    });
  });

  // Confirm add to cart
  document
    .getElementById("confirmAddToCart")
    .addEventListener("click", function () {
      const productId = document.getElementById("modalProductId").value;
      const selectedSize = document.getElementById("productSize").value;
      const quantity = 1; // Always 1 since we removed quantity input

      if (!selectedSize) {
        alert("Please select a size.");
        return;
      }

      fetch("/cart/add-from-wishlist", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          productId: productId,
          size: selectedSize,
          quantity: quantity,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            $("#sizeModal").modal("hide");

            $("#sizeModal").on("hidden.bs.modal", function () {
              $("#successModal").modal("show");

              $(this).off("hidden.bs.modal");
            });
          } else {
            alert(data.message || "Error adding product to cart.");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Internal server error. Please try again later.");
        });
    });

  // Reset form when size modal is hidden
  $("#sizeModal").on("hidden.bs.modal", function () {
    document.getElementById("sizeForm").reset();
  });
</script>
