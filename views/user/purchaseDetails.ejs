<%- include("../../views/partials/users/header.ejs") %>

<style>
    .order-card {
        background: #fff;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .badge-status {
        background-color: #d4f5e9;
        color: #28a745;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
    }
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
</style>

<body>
    <div class="container mt-9">
        <h2 class="mb-3">Order Details</h2>
        <div class="order-card">
            <h5>Order ID: #<%= order.id %></h5>
            <p><small><%= order.createdAt %></small></p>
            <span class="badge-status"><%= order.orderStatus %></span>
        
            <h2>Products Ordered</h2>
            <ul class="list-unstyled">
                <% order.products.forEach(product => { %>
                    <li class="d-flex justify-content-between align-items-center border-bottom py-3">
                        <!-- Product Info on Left -->
                        <div>
                            <p><strong>Product:</strong> <%= product.productId.title || 'No title available' %></p>
                            <p><strong>Price:</strong> ₹<%= product.productId.price.toFixed(2) %></p>
                            <p><strong>Quantity:</strong> <%= product.quantity %></p>
                            <p><strong>Size:</strong> <%= product.size %></p>
                            
                            <!-- ✅ Check Product Status and Display Appropriate Buttons or Messages -->
                            <% if (product.status === "Cancelled") { %>
                                <span class="text-danger fw-bold">Cancelled</span>
                            <% } else if (product.status === "Returned") { %>
                                <span class="text-success fw-bold">Returned</span>
                            <% } else if (product.status === "Return Rejected") { %>
                                <span class="text-warning fw-bold">Return Rejected</span>
                            <% } else if (["Pending", "Confirmed", "Shipped"].includes(product.status) && order.products.length > 1) { %>
                                <!-- ✅ Show Cancel Product Button ONLY if there is more than 1 product -->
                                <button class="btn btn-warning mt-2" onclick="cancelProduct('<%= order._id %>', '<%= product.productId._id %>', '<%= product.productOrderId %>')">
                                    Cancel Product
                                </button>
                            <% } else if (product.status === "Delivered" && order.products.length > 1) { %>
                                <!-- ✅ Show Return Product Button ONLY if there is more than 1 product -->
                                <% if (product.status !== "Returned" && product.status !== "Return Requested") { %>
                                    <button class="btn btn-danger mt-2" onclick="openReturnModal('<%= order._id %>', '<%= product.productId._id %>', '<%= product.productOrderId %>')">
                                        Return Product
                                    </button>
                                <% } else if (product.status === "Return Requested") { %>
                                    <span class="text-warning fw-bold">Return Requested</span>
                                <% } %>
                            <% } %>
                        </div>
            
                        <!-- Product Image on Right -->
                        <div>
                            <img src="<%= product.productId.image.length > 0 ? product.productId.image[0] : '/images/placeholder.jpg' %>" 
                                 alt="<%= product.productId.title %>" width="200" class="img-fluid rounded">
                        </div>
                    </li>
                <% }) %>
            </ul>
            
            
            
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Customer</h5>
                    <p><strong>Name:</strong> <%= order.userId.username %></p>
                    <p><strong>Email:</strong> <%= order.userId.email %></p>
                    <p><strong>Phone:</strong> <%= order.userId.contact %></p>
                </div>
                <div class="col-md-6">
                    <h5>Order Info</h5>
                    <p><strong>Shipping:</strong> <%= order.shipping %></p>
                    <p><%= order.shippingAddress.fullName %>, <%= order.shippingAddress.address %>,<br>
                       <%= order.shippingAddress.city %>, <%= order.shippingAddress.state %>, <%= order.shippingAddress.postalCode %></p>
                    <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                    <p><strong>Status:</strong> <%= order.orderStatus%></p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h5>Payment Info</h5>
                    <p><strong>Card:</strong> **** **** **** <%= order.cardLastFour %></p>
                    <p><strong>Business Name:</strong> <%= order.userId.username %></p>
                    <p><strong>Phone:</strong> <%= order.userId.contact %></p>
                </div>
                <div class="col-md-6">
                    <h5>Notes</h5>
                    <textarea class="form-control" placeholder="Type some note..."></textarea>
                    <button class="btn btn-primary mt-2">Save</button>
                </div>
            </div>
            
            <!-- Return Order Button (Hidden if order is already returned) -->
            <!-- Order-Level Action Button -->
            <% if (order.orderStatus === "Pending" || order.orderStatus === "Confirmed" || order.orderStatus === "Shipped") { %>
                <button class="btn btn-warning mt-3" id="cancelOrder" onclick="cancelOrder('<%= order._id %>')">Cancel Order</button>
            <% } else if (order.orderStatus === "Delivered") { %>
                <button class="btn btn-danger mt-3" id="returnOrder" data-bs-toggle="modal" data-order-id="<%= order._id %>" data-bs-target="#returnModal">Return Order</button>
            <% } %>
            

        </div>
    </div>

<!-- Return Modal -->
<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnModalLabel">Return Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="returnForm">
                    <input type="hidden" id="returnOrderId">
                    <input type="hidden" id="returnProductId">
                    <input type="hidden" id="returnProductOrderId">

                    <label for="reason">Select a Reason:</label>
                    <select class="form-select" id="reason" required>
                        <option value="Damaged product">Damaged product</option>
                        <option value="Wrong item received">Wrong item received</option>
                        <option value="Not as described">Not as described</option>
                        <option value="Other">Other</option>
                    </select>

                    <div class="mt-2">
                        <label for="customReason">Additional Details (Optional):</label>
                        <textarea class="form-control" id="customReason" placeholder="Enter additional details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-danger" onclick="submitReturn()">Submit Return</button>
            </div>
        </div>
    </div>
</div>
<!-- Return All Products Modal -->
<div class="modal fade" id="returnAllModal" tabindex="-1" aria-labelledby="returnAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="returnAllModalLabel">Return All Products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to return all products in this order?</p>

                <label for="returnAllReason">Select a Reason:</label>
                <select class="form-select" id="returnAllReason" required>
                    <option value="Damaged product">Damaged product</option>
                    <option value="Wrong item received">Wrong item received</option>
                    <option value="Not as described">Not as described</option>
                    <option value="Other">Other</option>
                </select>

                <div class="mt-2">
                    <label for="returnAllCustomReason">Additional Details (Optional):</label>
                    <textarea class="form-control" id="returnAllCustomReason" placeholder="Enter additional details..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger" onclick="submitReturnAll()">Submit Return</button>
            </div>
        </div>
    </div>
</div>


<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Larger modal for better shape -->
        <div class="modal-content" style="border-radius: 10px; padding: 20px;"> <!-- Rounded corners & padding -->
            <div class="modal-header">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                <p style="font-size: 18px; font-weight: 500;">Your Return Request successfully completed. <br> Action will be taken within 24 hours.</p>
            </div>
            <div class="modal-footer justify-content-center">
            </div>
        </div>
    </div>
</div>

<!-- ✅ Success Modal for Product Cancellation -->
<div class="modal fade" id="cancelSuccessModal" tabindex="-1" aria-labelledby="cancelSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelSuccessModalLabel">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="text-success fw-bold">Product has been successfully cancelled!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Error Modal for Product Cancellation -->
<div class="modal fade" id="cancelErrorModal" tabindex="-1" aria-labelledby="cancelErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="cancelErrorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p id="cancelErrorMessage" class="text-danger fw-bold">An error occurred while cancelling the product.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Order Cancellation Success Modal -->
<!-- Order Cancellation Success Modal -->
<div class="modal fade" id="cancelSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-success">Order Cancelled</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success" style="font-size: 50px;"></i>
                <p class="mt-2">Your cancel request has been submitted successfully!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="reloadPage()">OK</button>
            </div>
        </div>
    </div>
</div>



<script>
function openReturnModal(orderId, productId, productOrderId) {
    console.log("openReturnModal called with:", { orderId, productId, productOrderId });

    if (!orderId || !productId || !productOrderId) {
        console.error("Missing parameters in openReturnModal!", { orderId, productId, productOrderId });
        return;
    }

    document.getElementById('returnOrderId').value = orderId;
    document.getElementById('returnProductId').value = productId;
    document.getElementById('returnProductOrderId').value = productOrderId;

    var returnModal = new bootstrap.Modal(document.getElementById('returnModal'));
    returnModal.show();
}


async function submitReturn() {
    const orderId = document.getElementById('returnOrderId').value;
    const productId = document.getElementById('returnProductId').value;
    const productOrderId = document.getElementById('returnProductOrderId').value;
    const reason = document.getElementById('reason').value;
    const customReason = document.getElementById('customReason').value;

    if (!orderId || !productId || !productOrderId) {
        alert("Order ID, Product ID, and Product Order ID are required.");
        return;
    }

    try {
        console.log('Submitting return request...', { orderId, productOrderId, productId });

        const response = await fetch(`/returnRequested/${orderId}/${productOrderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId, reason, customReason })
        });

        console.log("Response received:", response);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Return response:", data);

        if (data.success) {
            var successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();

            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert('Error processing return request: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
    }
}


document.getElementById('returnOrder').addEventListener('click', function (e) {
    e.preventDefault();
    const orderId = this.getAttribute('data-order-id');
    console.log('Return Order Button Clicked, orderId:', orderId);
    
    // Store the orderId for later use in the submitReturnAll function
    document.getElementById('returnAllModal').setAttribute('data-order-id', orderId);
    
    // Show the return all products modal
    const returnAllModal = new bootstrap.Modal(document.getElementById('returnAllModal'));
    returnAllModal.show();
});

async function submitReturnAll() {
    const orderId = document.getElementById('returnAllModal').getAttribute('data-order-id');
    console.log('Submitting return for orderId:', orderId);
    const reason = document.getElementById('returnAllReason').value;
    const customReason = document.getElementById('returnAllCustomReason').value;
    
    try {
        // ✅ Add `await` before `fetch`
        const response = await fetch(`/requestReturn/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason, customReason })
        });

        // ✅ Ensure response is valid before parsing JSON
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        // ✅ Call `json()` without arguments
        const data = await response.json();
        console.log('Return response:', data);
        
        // ✅ Use `data.success` instead of `result.success`
        if (data.success) {
            var successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();

            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            alert(data.message || 'Failed to submit return request.');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
    }
}



// Function to cancel individual product
async function cancelProduct(orderId, productId, productOrderId) {
    console.log("cancelProduct called with:", { orderId, productId, productOrderId });

    if (!orderId || !productId || !productOrderId) {
        console.error("Missing parameters in cancelProduct!", { orderId, productId, productOrderId });
        return;
    }

    if (!confirm("Are you sure you want to cancel this product?")) {
        return;
    }

    try {
        const response = await fetch(`/cancelProduct/${orderId}/${productOrderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Cancellation response:", data);

        if (data.success) {
            // Show success modal
            var successModal = new bootstrap.Modal(document.getElementById('cancelSuccessModal'));
            successModal.show();
        } else {
            alert("Error cancelling product: " + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
    }
}

// Function to cancel entire order
async function cancelOrder(orderId) {
    console.log("cancelOrder called with orderId:", orderId);

    if (!orderId) {
        console.error("Missing order ID in cancelOrder!");
        return;
    }

    if (!confirm("Are you sure you want to cancel the entire order?")) {
        return;
    }

    try {
        const response = await fetch(`/orderCancel/${orderId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log("Order cancellation response:", data);

        if (data.success) {
            // Show success modal
            var successModal = new bootstrap.Modal(document.getElementById('cancelSuccessModal'));
            successModal.show();
        } else {
            alert('Error cancelling order: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Something went wrong. Please try again.');
    }
}

</script>
 



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<%- include("../../views/partials/users/footer.ejs") %>