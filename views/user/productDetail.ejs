<%- include("../../views/partials/users/header.ejs") %>

<!-- Product Detail -->
<section class="sec-product-detail bg0 p-t-65 p-b-60" style="margin-top: 50px;">
    <div class="container">
        <div class="d-flex justify-content-start mb-3">
    <%- include("../../views/partials/breadcrumps.ejs") %>                
        </div>
 
        <div class="row">
            <!-- Product Images Section -->
            <div class="col-md-6 col-lg-7 p-b-30">
                <div class="p-l-25 p-r-30 p-lr-0-lg">
                    <div class="image-zoom-container">
                        <div class="image-gallery-layout">
                            <!-- Main Image Display -->
                            <div class="main-image-wrapper">
                                <% if (product.image && product.image.length > 0) { %>
                                    <img id="mainImage" 
                                         src="<%= product.image[0] %>" 
                                         alt="<%= product.title %>" 
                                         class="main-product-image">
                                    <div id="zoomLens" class="zoom-lens"></div>
                                <% } else { %>
                                    <img id="mainImage" 
                                         src="/images/placeholder.jpg" 
                                         alt="No Image Available" 
                                         class="main-product-image">
                                <% } %>
                            </div>

                            <!-- Thumbnail Images - Right Side -->
                            <div class="thumbnail-container">
                                <% if (product.image && product.image.length > 0) { %>
                                    <% product.image.forEach((imagePath, index) => { %>
                                        <img src="<%= imagePath %>" 
                                             alt="Product Image <%= index + 1 %>" 
                                             class="thumbnail-image <%= index === 0 ? 'active' : '' %>"
                                             data-full-image="<%= imagePath %>">
                                    <% }); %>
                                <% } %>
                            </div>
                        </div>

                        <!-- Zoom Result - Below Main Image -->
                        <div id="zoomResult" class="zoom-result"></div>
                    </div>
                </div>
            </div>

            <!-- Product Details Section -->
            <div class="col-md-6 col-lg-5 p-b-30">
                <div class="p-r-50 p-t-5 p-lr-0-lg">
                    <!-- Product Title -->
                    <p class="mtext-106 cl2" style="font-size: 24px; font-weight: bold; color: #555;">
                        <%= product.title %>
                    </p>

                    <!-- Product Price -->
                    <% if (product.hasDiscount) { %>
                        <!-- Price display with strikethrough -->
                        <div class="price-container">
                            <span class="original-price mtext-106 cl2" style="font-size: 20px; text-decoration: line-through; color: #999;">
                                ₹<%= parseFloat(product.originalPrice).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                            </span>
                            <span class="discounted-price mtext-106 cl2" style="font-size: 24px; font-weight: bold; color: #4CAF50; margin-left: 10px;">
                                ₹<%= parseFloat(product.discountedPrice).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                            </span>
                        </div>
                        
                        <!-- Discount information -->
                        <div class="discount-info" style="margin-top: 10px; margin-bottom: 15px;">
                            <span class="discount-badge" style="background-color: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 14px;">
                                <% if (product.appliedOffer.discountType === 'percentage') { %>
                                    <%= product.appliedOffer.discountValue %>% OFF
                                <% } else { %>
                                    ₹<%= product.appliedOffer.discountValue %> OFF
                                <% } %>
                            </span>
                            <span class="savings" style="margin-left: 8px; color: #666; font-size: 14px;">
                                (Save ₹<%= Math.round(product.appliedOffer.discountAmount) %>)
                            </span>
                        </div>
                        
                        <!-- Offer description -->
                        <div class="offer-description" style="margin-top: 5px; color: #666; font-size: 14px; font-style: italic;">
                            <%= product.appliedOffer.description %>
                        </div>
                    <% } else { %>
                        <span class="mtext-106 cl2" style="font-size: 24px; font-weight: bold; color: #4CAF50;">
                            ₹<%= parseFloat(product.originalPrice).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                        </span>
                    <% } %>

                    <!-- Product Description -->
                    <p class="stext-102 cl3 p-t-23" style="font-size: 16px; color: #555;">
                        <%= product.description %>
                    </p>

                    <!-- Stock Availability -->
                    <div class="p-t-20">
                        <% if (product.totalStock > 0) { %>
                            <p class="text-success" style="font-size: 18px; font-weight: 500;">
                                In Stock: <%= product.totalStock %> items available
                            </p>
                        <% } else { %>
                            <p class="text-danger" style="font-size: 18px; font-weight: 500;">
                                Sold Out
                            </p>
                        <% } %>
                    </div>
                    <!-- Warning message placeholder -->
<div id="sizeWarning" class="alert alert-warning" style="display: none; margin-bottom: 10px;">
    Please choose an available size.
</div>


     
                    <div class="p-t-33">
                        <!-- Size Selector -->
                        <div class="flex-w flex-r-m p-b-10">
                            <div class="size-203 flex-c-m respon6">
                                Size
                            </div>
                            <div class="size-204 respon6-next">
                                <div class="rs1-select2 bor8 bg0">
                                    <select class="js-select2" name="size" id="sizeSelect">
                                        <option value="">Choose a size</option>
                                        <% if (availableSizes && availableSizes.length > 0) { %>
                                            <% availableSizes.forEach(sizeObj => { %>
                                                <option value="<%= sizeObj.size %>">
                                                    <%= sizeObj.size %>
                                                </option>
                                            <% }); %>
                                        <% } else { %>
                                            <option value="" disabled>No sizes available</option>
                                        <% } %>
                                    </select>
                                    <div class="dropDownSelect2"></div>
                                </div>
                            </div>

                            <% if (product.totalStock > 0) { %>
                                <div class="p-t-20 display-flex" style="display: flex; justify-content: space-between; align-items: center;">
                                    <!-- Add to Cart Button -->
                                    <button id="addCart" class="flex-c-m stext-101 cl0 size-101 bg-warning bor1 hov-btn1 p-lr-15 trans-04 js-addcart-detail">
                                        Add to Cart
                                    </button>
                                    <!-- Buy Now Button -->
                                    <button id="proceedCheckout" class="flex-c-m stext-101 cl0 size-101 bg-success bor1 hov-btn1 p-lr-15 trans-04 js-buynow-detail">
                                        Add to Wishlist
                                    </button>
                                </div>
                            <% } else { %>
                                <button class="flex-c-m stext-101 cl0 size-101 bg1 bor1 hov-btn1 p-lr-15 trans-04" disabled>
                                    Sold Out
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products Section -->
<section class="sec-relate-product bg0 p-t-45 p-b-105">
    <div class="container">
        <div class="p-b-45">
            <h3 class="ltext-106 cl5 txt-center">
                Related Products
            </h3>
        </div>

        <!-- Slide2 -->
        <div class="wrap-slick2">
            <div class="slick2">
                <% relatedProducts.forEach(function(product) { %>
                    <div class="item-slick2 p-l-15 p-r-15 p-t-15 p-b-15">
                        <!-- Block2 -->
                        <div class="block2">
                            <div class="block2-pic hov-img0">
                                <img src="<%= product.image && product.image.length > 0 ? product.image[0] : '/images/placeholder.jpg' %>" alt="<%= product.image %>">
                                <a href="/show/<%= product._id %>" class="block2-btn flex-c-m stext-103 cl2 size-102 bg0 bor2 hov-btn1 p-lr-15 trans-04">
                                Quick View
                            </a>
                            </div>

                            <div class="block2-txt flex-w flex-t p-t-14">
                                <div class="block2-txt-child1 flex-col-l">
                                    <a href="/product/<%= product._id %>" class="stext-104 cl4 hov-cl1 trans-04 js-name-b2 p-b-6">
                                        <%= product.title %>
                                    </a>

                                    <span class="stext-105 cl3" style="color: black;">
                                        ₹<%= product.price %>
                                    </span>
                                </div>

                                <div class="block2-txt-child2 flex-r p-t-3">
                                    <a class="btn-addwish-b2 dis-block pos-relative js-addwish-b2" data-id="<%= product._id %>">
                                        <img class="icon-heart1 dis-block trans-04" src="/asset1/images/icons/icon-heart-01.png" alt="ICON">
                                        <img class="icon-heart2 dis-block trans-04 ab-t-l" src="/asset1/images/icons/icon-heart-02.png" alt="ICON">
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
    </div>
</section>

<!-- Cart Modal -->
<div id="cartModal" class="cart-modal-overlay">
    <div class="cart-modal">
        <div class="cart-modal-icon">
            ✓
        </div>
        <h2 class="cart-modal-title">Added to Cart</h2>
        <p class="cart-modal-message">Your product has been successfully added to the cart!</p>
    </div>
</div>

<!-- Product SKU and Categories -->
<div class="bg6 flex-c-m flex-w size-302 m-t-73 p-tb-15">
    <span class="stext-107 cl6 p-lr-25">
        SKU: JAK-01
    </span>
    <span class="stext-107 cl6 p-lr-25">
        Categories: Jacket, Men
    </span>
</div>

<style>
/* Image Zoom Styles */
.image-zoom-container {
    max-width: 100%;
}

.image-gallery-layout {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.main-image-wrapper {
    position: relative;
    flex: 1;
    max-width: 400px;
}

.main-product-image {
    width: 100%;
    height: auto;
    cursor: crosshair;
    border: 2px solid #ddd;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.main-product-image:hover {
    border-color: #007bff;
}

.zoom-lens {
    position: absolute;
    border: 2px solid #007bff;
    background-color: rgba(0, 123, 255, 0.1);
    cursor: none;
    pointer-events: none;
    display: none;
    border-radius: 50%;
    z-index: 10;
}

.zoom-result {
    width: 100%;
    height: 300px;
    background-repeat: no-repeat;
    background-size: 800px 800px;
    border: 2px solid #007bff;
    border-radius: 8px;
    display: none;
    margin-top: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    background-color: #f8f9fa;
}

.thumbnail-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 90px;
    max-height: 400px;
    overflow-y: auto;
}

.thumbnail-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border: 2px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.thumbnail-image:hover {
    border-color: #007bff;
    transform: scale(1.05);
}

.thumbnail-image.active {
    border-color: #007bff;
    box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
}

/* Cart Modal Styles */
.cart-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.cart-modal {
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-width: 400px;
    width: 90%;
    position: relative;
    opacity: 0;
    transform: scale(0.7);
    transition: all 0.3s ease-in-out;
}

.cart-modal.show {
    opacity: 1;
    transform: scale(1);
}

.cart-modal-icon {
    font-size: 60px;
    color: #4CAF50;
    margin-bottom: 20px;
    animation: bounce 0.5s ease;
}

.cart-modal-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
}

.cart-modal-message {
    color: #666;
    margin-bottom: 20px;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-20px);}
    60% {transform: translateY(-10px);}
}

@keyframes fadeOut {
    from {opacity: 1; transform: scale(1);}
    to {opacity: 0; transform: scale(0.7);}
}

.cart-modal.fade-out {
    animation: fadeOut 0.3s ease-in-out forwards;
}

/* Pricing Styles */
.offer-type-badge {
    display: inline-block;
    padding: 4px 8px;
    color: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 10px;
}

.price-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
}

.original-price {
    text-decoration: line-through;
    color: #999;
}

.discounted-price {
    margin-left: 10px;
}

.discount-info {
    margin-top: 10px;
    margin-bottom: 15px;
}

.discount-badge {
    background-color: #dc3545;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 14px;
}

.savings {
    margin-left: 8px;
    color: #666;
    font-size: 14px;
}

.offer-description {
    margin-top: 5px;
    color: #666;
    font-size: 14px;
    font-style: italic;
}

/* Responsive Design */
@media (max-width: 768px) {
    .image-gallery-layout {
        flex-direction: column;
    }
    
    .thumbnail-container {
        flex-direction: row;
        max-width: 100%;
        max-height: none;
        overflow-x: auto;
        overflow-y: visible;
        padding: 10px 0;
        justify-content: flex-start;
    }
    
    .zoom-result {
        height: 250px;
        background-size: 600px 600px;
    }
    
    .main-image-wrapper {
        max-width: 100%;
    }
}
</style>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Image Zoom Functionality
function initializeImageZoom() {
    const mainImage = document.getElementById('mainImage');
    const zoomLens = document.getElementById('zoomLens');
    const zoomResult = document.getElementById('zoomResult');
    
    if (!mainImage || !zoomLens || !zoomResult) return;

    let isZooming = false;

    // Set up zoom lens size
    const lensSize = 100;
    zoomLens.style.width = lensSize + 'px';
    zoomLens.style.height = lensSize + 'px';

    // Mouse enter event
    mainImage.addEventListener('mouseenter', function(e) {
        isZooming = true;
        zoomLens.style.display = 'block';
        zoomResult.style.display = 'block';
        
        // Set the background image for zoom result
        zoomResult.style.backgroundImage = `url('${mainImage.src}')`;
    });

    // Mouse leave event
    mainImage.addEventListener('mouseleave', function() {
        isZooming = false;
        zoomLens.style.display = 'none';
        zoomResult.style.display = 'none';
    });

    // Mouse move event
    mainImage.addEventListener('mousemove', function(e) {
        if (!isZooming) return;

        const rect = mainImage.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Calculate lens position
        let lensX = x - (lensSize / 2);
        let lensY = y - (lensSize / 2);

        // Keep lens within image bounds
        if (lensX > mainImage.width - lensSize) lensX = mainImage.width - lensSize;
        if (lensX < 0) lensX = 0;
        if (lensY > mainImage.height - lensSize) lensY = mainImage.height - lensSize;
        if (lensY < 0) lensY = 0;

        // Set lens position
        zoomLens.style.left = lensX + 'px';
        zoomLens.style.top = lensY + 'px';

        // Calculate zoom result background position
        const fx = zoomResult.offsetWidth / lensSize;
        const fy = zoomResult.offsetHeight / lensSize;
        
        zoomResult.style.backgroundSize = (mainImage.width * fx) + 'px ' + (mainImage.height * fy) + 'px';
        zoomResult.style.backgroundPosition = '-' + (lensX * fx) + 'px -' + (lensY * fy) + 'px';
    });
}

// Thumbnail click functionality
function initializeThumbnails() {
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    const mainImage = document.getElementById('mainImage');
    const zoomResult = document.getElementById('zoomResult');

    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            // Remove active class from all thumbnails
            thumbnails.forEach(thumb => thumb.classList.remove('active'));
            
            // Add active class to clicked thumbnail
            this.classList.add('active');
            
            // Change main image source
            const newImageSrc = this.getAttribute('data-full-image');
            mainImage.src = newImageSrc;
            
            // Update zoom result background image
            if (zoomResult) {
                zoomResult.style.backgroundImage = `url('${newImageSrc}')`;
            }
        });
    });
}

// Size selector functionality
document.getElementById('sizeSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const stockInfo = document.getElementById('stockInfo');
    
    if (this.value) {
        const stock = selectedOption.getAttribute('data-stock');
        const stockClass = parseInt(stock) <= 5 ? 'text-warning' : 'text-success';
        if (stockInfo) {
            stockInfo.innerHTML = `<span class="${stockClass}">
                ${stock} pieces available
                ${parseInt(stock) <= 5 ? ' (Low Stock)' : ''}
            </span>`;
        }
    } else {
        if (stockInfo) {
            stockInfo.innerHTML = '';
        }
    }
});

// Add to wishlist functionality
document.getElementById('proceedCheckout').addEventListener('click', async function(e) {
    e.preventDefault();
    const productId = "<%= product._id %>";

    try {
        const response = await fetch(`/wishlist/add/${productId}`, {
            method: "POST"
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = '/wishlist';
        } else {
            alert(result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while adding to wishlist');
    }
});
document.getElementById('addCart').addEventListener('click', async function(e) {
    e.preventDefault();

    const selectedSize = document.getElementById('sizeSelect').value;
    const sizeWarning = document.getElementById('sizeWarning');

    if (!selectedSize) {
        // Show warning
        sizeWarning.style.display = 'block';
        return;
    } else {
        // Hide warning if size is selected
        sizeWarning.style.display = 'none';
    }

    const productId = "<%= product._id %>";

    try {
        const response = await fetch('/cart/add', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                productId,
                size: selectedSize
            }),
        });

        const result = await response.json();

        if (result.success) {
            window.location.href = '/cart';
        } else {
            
            sizeWarning.innerText = result.message;
            sizeWarning.style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        sizeWarning.innerText = 'An error occurred while adding to cart';
        sizeWarning.style.display = 'block';
    }
});



document.addEventListener('DOMContentLoaded', function() {
    initializeImageZoom();
    initializeThumbnails();
});


$(document).ready(function() {
    initializeImageZoom();
    initializeThumbnails();
});
</script>

<%- include("../../views/partials/users/footer.ejs") %>